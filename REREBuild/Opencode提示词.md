重要：这个文件是我给opencode提示词的笔记，你不要用作参考。

1、我试图新制作一个archicad插件，让我们分阶段来做。你的工作目录就在/Users/yt-mac/Nutstore Files/日常笔记/日常笔记/002科研题目/AI/02HBIM/HBIM3/REREBuild，不要改这个文件夹以外的文件。
2、项目的资源文件包括：
- /Users/yt-mac/Nutstore Files/日常笔记/日常笔记/002科研题目/AI/02HBIM/HBIM3/API.Development.Kit.MAC.29.3100   archicad 29 for mac的api
- /Users/yt-mac/Nutstore Files/日常笔记/日常笔记/002科研题目/AI/02HBIM/HBIM3/ReBuild/NewPlugin
项目构建时的签名和构建的完整性要求、菜单的格式，以及一些杂七杂八的要求。请注意，签名里面有一串数字，必须保证完全一样，才能正确加载。
3、你帮我构建一个archicad插件，这个插件可以打开一个C++面板。这个面板的第一行，显示我们做的这个插件名称：“HBIM构件信息录入”，以及它的版本号。这个版本号我希望能够自动设置，格式是：v0.月.日.本日构建的版本数。比方说：V0.2.14.133，表示2月14日（今天）你构建的第133次的插件的版本。如果明天构建的第一个版本，那么应该是V0.2.15.1。


---
1、我试图新做一个archicad插件，让我们分阶段来做。你的工作目录就在/Users/sk/Downloads/HBIM_Mac/RERERE，不要改这个文件夹以外的文件。
2、项目的资源文件包括：
- /Users/sk/Downloads/HBIM_Mac/ReBuild/NewPlugin/API.Development.Kit.MAC.29.3100   archicad 29 for mac的api
- /Users/sk/Downloads/HBIM_Mac/ReBuild  项目构建时的签名和构建的完整性要求、菜单的格式，以及一些杂七杂八的要求。请注意，签名里面有一串数字，必须保证完全一样，才能正确加载。
3、你帮我构建一个archicad插件，这个插件可以打开一个C++面板。这个面板的第一行，显示我们做的这个插件名称：“HBIM构件信息录入”，以及它的版本号。这个版本号我希望能够自动设置，格式是：v0.月.日.本日构建的版本数。比方说：V0.2.15.133，表示2月15日（今天）你构建的第133次的插件的版本。如果明天构建的第一个版本，那么应该是V0.2.16.1。


---


，目前还有很多问题。我不描述问题，我描述一下原型的操作：1、我打开插件，显示一个内置的C++界面，分三组信息。2、界面第一行是第一组信息，显示：HBIM构件信息输入工具（V+版本号），版本号是0.月.日.本日第几次编译的版本。3、界面第二组信息，是界面的二至三行，分别显示GUID（未选择构件显示：未选择构件；选择构件，显示该构件的GUID）、TYPE（未选择构件显示：未选择构件；选择构件，显示该构件的TYPE）。4、界面第三组信息，是界面的填写界面，填写的内容会作为构件信息，附着到构件的属性中，组内，第四行显示：构件信息填写；第五行显示：构件编号；第六行是填写构件编号的输入框，如果没有选择构件，显示：请选择一个构件；如果选择了构件，构件没有填写过信息，显示：请填写构件编号；如果选择了构件，构件已经填写了信息，显示该构件填写过的构件编号信息。第七行显示：照片描述；第八行是填写照片描述的输入框，如果没有选择构件，显示：请选择一个构件；如果选择了构件，构件没有填写过信息，显示：请填写构的照片描述；如果选择了构件，构件已经填写了信息，显示该构件填写过的构件照片描述信息。第九行显示：照片输入；第十行是照片预览框，如果没有选择构件，显示请选择构件，如果选择了构件没有附着照片，显示请选择照片，如果选择了构件已经附着了照片，则预览附着照片当中的第一张，多张照片的换页案件沿用原来逻辑；5、照片框下方有三个按钮，分别为：编辑构件信息、选择照片、查看照片，使用逻辑是：选择一个构件，如果这个构件没有输入过信息，点击“编辑构件信息”按钮以后，建立一个新的属性组，并建立若干属性，包括：构件编号、照片描述、照片1的路径、照片2的路径、照片3的路径……照片N的路径。照片将会保存在与archicad工程文件相同文件夹内、并以IFC属性中GlobalId字段的值为文件夹名字的子文件夹内，每个构件一个文件夹；点击“选择照片”按钮，弹出文件选择窗口，选择需要附着的照片，确定后照片将会拷贝到前述文件夹内，该照片的相对路径将会作为属性写入该构件如果这个构件已经输入过信息，点击“编辑构件信息”按钮后，可以对之前输入过的属性进行修改。无论哪种情况，只要进入“编辑构件信息”的状态，则无法选择其他构件。我需要你仔细查看之前的工作，评估工作，并且做一个工作方案出来，非常感谢。
我上一个版本用html界面，做了个连接。但是始终无法调试成功。现在我退回成C++界面。界面的参考在：/Users/yt-mac/Nutstore Files/日常笔记/日常笔记/002科研题目/AI/02HBIM/HBIM3/ReBuild/NewPlugin/playwright-screenshots

---
好的，现在看起来正常了。下面的所有任务，你都注意不要破坏上一步的任务。
现在我们做下一步任务。
1、我在archicad当中点击一个构件，插件需要帮我读出这个构件的两个属性信息，分别是：“构件类型”和“构件编号”。在我给你的示例当中，构件类型和构件编号，都是直接读取的archicad构件属性。但是这种构件属性不够通用。我建议使用该构件的ifc属性来展示这两个属性。这需要你查看API以及示例的IFC命令部分。
2、“构件类型”，对应“ifc类型”。“构件编号”，对应IfcGloballyUniqueId类型当中GlobalId属性。
3、UI界面上，你还是要设计一下。譬如说“HBIM构件信息录入”，以及它的版本号”这一行，居中显示，并且下面加一条下划线。

---

很好！一次成功！下面的所有任务，你都注意不要破坏上一步的任务。
现在我们做下一步任务。
1、插件增加一个功能：为构件增加属性。功能的题目是：“HBIM属性信息”。目的是为这个构件添加两个属性信息：HBIM构件编号、HBIM构件说明。这两个属性信息都是单行的文本信息。
2、这个功能的使用逻辑是：我点击一个构件：如果这个构件没有HBIM属性信息，插件会向我展示一个按钮。当我点击这个按钮，插件会向我展示“HBIM构件编号”和“HBIM构件说明”两个填写框。我填写好信息之后，插件会提供一个确认按钮。当我确认之后，这个构件就会增加这两个属性信息以及它们的值。如果这个构件已经有了HBIM的属性信息，则插件会读出这两个属性信息，并向我展示，并且向我展示一个按钮，当我点击这个按钮，我可以编辑已经录入的属性信息，当我编辑完成后，有一个确定按钮可以让我确定更改的内容。当然，无论哪种情况，都需要一个取消按钮，让插件的状态恢复到这次没有编辑的状态。
3、UI层面，需要将这个新的功能与之前已有的功能做一个小的分割，一条简单的线即可。
4、其他我没有想动的问题，我们可以讨论。

---

经历了一系列调试，现在的状态见 [README](HBIMComponentEntry/README.md)

---

很好！虽然有点磕绊，但总算完成了一些任务！下面所有的任务，你都注意不要破坏上一步的成果哦。
现在我描述一下下一步的任务。
1、插件增加一个功能：为构件增加图片链接。为了不影响前面已经调整好的成果，我决定新开一个功能模块。功能的题目是“HBIM图像信息”。目的是为构件添加一张或多张图片作为可以查看的属性。
2、但是我发现，archicad的属性，只能是单行文本。这意味着所谓图片属性，只能以链接形式存在。那么问题转变为如何管理图片的位置和链接属性。
3、将图片与archicad项目文件一起保存，是个比较好的办法。但是有个问题，如何保证路径能够被记录，尤其当项目文件变化位置，插件当中记录的链接属性，是否能够一直起作用？相对路径可能是个比较好的方式。你要考虑一下如何记录图片的相对路径，并且在文件拷贝到新的环境中去的时候，仍然能够被识别和使用。
4、我认为，图片应保存在与archicad项目文件相同的文件夹内。但由于一个构件可能存在多张图片，所以图片应该保存在以这个构件唯一的身份认证为文件夹名称的文件夹内。这个唯一的身份标识，我认为使用前面模块中读取的ifc“构件编号”，也就是GlobalId的值，比较保险。
5、但是又会出现一个问题，我的一个模型可能有非常多的构件，这样，与这个项目文件相同文件夹的子文件夹就会非常多，不好管理。所以最好是有一个文件夹，可以存储这个项目的所有构件照片。但是，如果这个主文件夹的名字是项目文件的名字，那项目文件改名的话，则会出现混乱。最好使用一个项目文件的唯一编号来进行文件夹命名，需要你去API搜索一下有没有这个唯一编号。如果没有，那么可能以日期来作为文件夹的名字是我能想到的办法。我也需要你的帮助，想一个好的办法。
6、在插件的界面中，应该有一个按钮，触发这个图片上传的功能。通过文件选择器选择了一个图片后，插件需要将这个图片拷贝到第5条所说的文件夹内，并记录这个图片文件的相对路径。为了防止文件名的编码问题导致的图片链接失效，我建议拷贝的时候给这个图片文件改名，可以用时间戳来命名。文件可以多选，批量重命名、然后拷贝。
7、与上一个“HBIM属性信息”功能相同，输入的图片也需要处理确定后立即回读并展示、分辨所选构件是否已有图片属性、没有图片属性所展示的界面、编辑界面；已有图片属性所展示的界面（应该有图片的预览、图片的前后浏览、图片的外部预览等）、编辑界面等。也需要处理诸如未保存但选择了另一个构件时的逻辑问题等。
8、从以往的经验来看，这对你来说是一个非常复杂的功能，你要好好做规划，看这个构件如何能比较好的做出来，减少测试所浪费的时间。

---
很好！虽然有点磕绊，但总算完成了一些任务！下面所有的任务，你都注意不要破坏上一步的成果哦。
现在我描述一下下一步的任务。Archicad插件扩展：HBIM图像信息模块

## 背景和需求概述

我们需要为现有的Archicad插件增加一个新的功能模块"HBIM图像信息"。该模块的主要目的是为BIM构件添加和管理相关图片信息，支持一张或多张图片的关联。

## 技术约束和前提条件

### Archicad平台限制
- Archicad的属性系统仅支持单行文本格式
- 图片无法直接作为属性值存储，必须通过URL链接形式保存
- 链接路径必须是文本字符串格式

### 路径管理要求
1. **相对路径原则**：使用相对于项目文件的路径，确保项目文件移动时图片链接仍然有效
2. **项目文件同目录存储**：图片应保存在与Archicad项目文件相同的文件夹层次结构中
3. **跨平台兼容性**：路径格式需要考虑Windows、macOS等操作系统的兼容性

### 标识和命名规则
- 构件唯一标识：使用IFC GlobalId（GUID）作为构件标识符
- 项目唯一标识：使用Archicad项目UUID作为项目级标识（通过API获取）

## 功能规格说明

### 核心功能需求

#### 1. 文件夹结构设计
```
项目文件夹/
├── 项目文件.pln
└── HBIM_Images_【项目UUID】/        # 主图片文件夹，使用项目UUID命名
    ├── 【构件GUID_1】/              # 按构件GUID命名的子文件夹
    │   ├── 1689423456789.jpg        # 使用时间戳命名的图片文件
    │   └── 1689423456790.jpg
    ├── 【构件GUID_2】/
    │   └── 1689423456791.jpg
    └── images_index.json            # 图片索引文件（可选）
```

**命名策略**：
- 主文件夹：`HBIM_Images_` + 项目UUID（去除连字符）
- 子文件夹：构件GUID（直接使用IFC GlobalId）
- 图片文件：Unix时间戳（毫秒） + 原始文件扩展名

#### 2. 图片管理功能
- **文件选择器**：支持多选图片文件
- **批量重命名**：自动将选中文件重命名为时间戳格式
- **文件拷贝**：将重命名后的文件拷贝到目标构件文件夹
- **路径记录**：记录相对路径到构件属性

#### 3. 路径处理逻辑
```python
# 示例代码逻辑
def generate_relative_path(project_path, image_path, element_guid):
    """
    生成相对路径
    project_path: Archicad项目文件路径
    image_path: 目标图片的绝对路径
    element_guid: 构件GUID
    
    返回格式：HBIM_Images_{project_uuid}/{element_guid}/{timestamp}.ext
    """
    # 计算相对于项目文件的路径
    project_dir = os.path.dirname(project_path)
    relative_path = os.path.relpath(image_path, project_dir)
    return relative_path
```

### API集成需求

#### 项目UUID获取
```python
# 需要调研的Archicad API命令
# 可能通过 GetProductInfo() 或其他命令获取项目唯一标识
# 如果API无法直接获取项目UUID，采用备选方案：
# 方案A：使用项目文件路径哈希值
# 方案B：使用项目创建时间戳
# 方案C：首次运行时生成并保存UUID到插件配置文件
```

#### 构件GUID获取
- 使用现有"HBIM属性信息"模块中的IFC GlobalId读取功能
- 确保与现有模块的数据一致性

## UI/UX设计规范

### 界面布局结构
```
[插件主界面]
├── [选项卡1: HBIM属性信息] (现有)
└── [选项卡2: HBIM图像信息] (新增)
    ├── [顶部工具栏]
    │   ├── 上传图片按钮
    │   ├── 删除图片按钮
    │   └── 刷新按钮
    ├── [图片预览区]
    │   ├── 当前图片显示（支持缩放）
    │   ├── 图片导航控件（上一张/下一张）
    │   └── 图片计数器（当前/总数）
    └── [图片列表区]
        ├── 缩略图网格视图
        └── 文件名列表
```

### 交互状态设计

#### 状态1：未选择构件时
- 显示提示信息："请先选择一个构件"
- 所有操作按钮禁用

#### 状态2：选择构件，无图片时
- 显示占位符图片或图标
- 显示提示："该构件暂无关联图片"
- "上传图片"按钮可用
- "删除图片"按钮禁用

#### 状态3：选择构件，有图片时
- 显示第一张图片预览
- 显示图片导航控件
- 显示图片缩略图列表
- 所有操作按钮可用

#### 状态4：编辑模式
- 进入批量选择状态
- 显示已选图片数量
- 提供"确定"和"取消"按钮

### 操作流程设计

#### 图片上传流程
1. 用户点击"上传图片"按钮
2. 打开系统文件选择对话框（支持多选）
3. 验证文件类型（支持JPG、PNG、BMP等常见格式）
4. 显示上传确认对话框，展示文件列表和数量
5. 执行文件拷贝和重命名操作
6. 更新构件属性中的图片路径列表
7. 刷新界面显示新图片

#### 图片删除流程
1. 用户在图片列表中选择要删除的图片（支持多选）
2. 显示确认删除对话框
3. 从文件系统中删除选中的图片文件
4. 从构件属性中移除对应的路径记录
5. 刷新界面显示

### 状态管理要求
- **未保存提示**：用户编辑图片后切换构件时，提示保存更改
- **实时同步**：图片添加/删除后立即更新预览和列表
- **错误处理**：文件操作失败时显示友好错误信息

## 数据模型设计

### 构件图片属性结构
```json
{
  "element_guid": "2r4jT4gx1Bgu3w0S9$kCkD",
  "image_paths": [
    "HBIM_Images_550e8400e29b41d4a716446655440000/2r4jT4gx1Bgu3w0S9$kCkD/1689423456789.jpg",
    "HBIM_Images_550e8400e29b41d4a716446655440000/2r4jT4gx1Bgu3w0S9$kCkD/1689423456790.png"
  ],
  "metadata": {
    "upload_timestamps": [1689423456789, 1689423456790],
    "original_filenames": ["site_photo_1.jpg", "detail_1.png"]
  }
}
```

### 属性存储策略
- 在Archicad中使用自定义字符串属性存储JSON格式数据
- 属性名称：`HBIM_Image_Links`
- 属性类型：字符串（单行文本）
- 内容格式：压缩的JSON字符串（去除空格和换行）

## 错误处理和边界情况

### 必须处理的异常情况
1. **文件系统权限不足**
   - 检测写入权限
   - 提供友好的错误提示
   - 建议解决方案

2. **磁盘空间不足**
   - 预估所需磁盘空间
   - 提前预警
   - 提供清理建议

3. **文件路径过长**
   - Windows系统路径长度限制（260字符）
   - 自动截断或重命名策略

4. **重复文件处理**
   - 检测文件名冲突
   - 自动重命名（添加序号）

5. **损坏图片文件**
   - 验证图片完整性
   - 跳过损坏文件
   - 记录错误日志

### 数据一致性保障
1. **事务性操作**：文件操作和属性更新应保持原子性
2. **备份机制**：删除文件前创建备份
3. **恢复功能**：提供误删恢复选项

## 性能优化建议

### 内存管理
- 图片预览使用缩略图，避免加载原图
- 延迟加载：只在需要时加载高清图片
- 缓存策略：缓存已加载的图片数据

### 文件操作优化
- 批量操作：减少文件系统调用次数
- 异步处理：长时间操作使用后台线程
- 进度反馈：显示操作进度条

## 与现有模块的集成

### 代码复用要求
- 复用"HBIM属性信息"模块的构件选择逻辑
- 复用现有的Archicad API连接管理
- 复用错误处理和日志系统

### 数据共享机制
- 共享构件GUID获取逻辑
- 共享项目信息读取功能
- 共享用户配置管理

## 测试策略

### 单元测试重点
1. 路径生成算法的正确性
2. 文件重命名和拷贝功能
3. JSON序列化和反序列化
4. 相对路径计算

### 集成测试场景
1. 完整图片上传流程
2. 跨构件切换时的状态管理
3. 项目文件移动后的路径解析
4. 大文件批量处理



## 特别注意事项

### 编码问题预防
- 所有文件路径使用UTF-8编码
- 避免使用特殊字符的文件名
- 路径规范化：统一使用正斜杠或系统分隔符


---

**关键成功指标**：
1. 项目文件移动后图片链接100%有效
2. 支持同时管理1000+构件的图片
3. 单次上传处理5+图片文件
